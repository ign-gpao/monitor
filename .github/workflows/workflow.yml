name: Workflow
on:
  push:
    branches:
      - main

jobs:
  tag:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: "âœï¸ Bump version and push tag"
      id: tagging
      uses: anothrNick/github-tag-action@1.36.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        WITH_V: false
    - name: "ğŸ–¨ï¸ Print new tag to console"
      run: |
        echo ${{steps.tagging.outputs.new_tag}}
    - name: "Update repo"
      run: |
        sudo chmod -R 777 .git
        git fetch --prune --unshallow
    - name: "Bump version package.json"
      run: |
        npm version --git-tag-version=false ${{steps.tagging.outputs.new_tag}}
    - name: "Bump version Dockerfile"
      run: |
        sed -ie "s/LABEL version=\"*.*.*\"/LABEL version=\"${{steps.tagging.outputs.new_tag}}\"/" docker/Dockerfile
    - name: "âœï¸ Generate full changelog"
      uses: heinrichreimer/github-changelog-generator-action@v2.3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        headerLabel: "# ğŸ“‘ Changelog"
        breakingLabel: '### ğŸ’¥ Breaking'
        enhancementLabel: '### ğŸš€ Enhancements'
        bugsLabel: '### ğŸ› Bug fixes'
        deprecatedLabel: '### âš ï¸ Deprecations'
        removedLabel: '### ğŸ”¥ Removals'
        securityLabel: '### ğŸ›¡ï¸ Security'
        issuesLabel: '### ğŸ“ Other issues'
        prLabel: '### ğŸ“ Other pull requests'
        addSections: '{"documentation":{"prefix":"### ğŸ“– Documentation","labels":["documentation"]},"tests":{"prefix":"### âœ… Testing","labels":["tests"]}}'
        issues: true
        issuesWoLabels: true
        pullRequests: true
        prWoLabels: true
        author: true
        unreleased: true
        compareLink: true
        stripGeneratorNotice: true
        verbose: true
    - name: "ğŸ–¨ï¸ Print changelog to console"
      run: cat CHANGELOG.md
    - name: "ğŸ“¤ Commit files"
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "github-actions[bot]"
        git add CHANGELOG.md
        git commit -am "[bot] Update changelog and version"
        git push
        git tag -d ${{steps.tagging.outputs.new_tag}}
        git push origin :${{steps.tagging.outputs.new_tag}}
        git tag ${{steps.tagging.outputs.new_tag}}
        git push origin ${{steps.tagging.outputs.new_tag}}
    - name: "Update repo"
      run: |
        git fetch --prune
    - name: "âœï¸ Generate release changelog"
      id: generate-release-changelog
      uses: heinrichreimer/github-changelog-generator-action@v2.3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        onlyLastTag: "true"
        stripHeaders: "true"
        stripGeneratorNotice: "true"
    - name: "ğŸš€ Create GitHub release"
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{steps.tagging.outputs.new_tag}}
        release_name: Release ${{steps.tagging.outputs.new_tag}}
        body: ${{ steps.generate-release-changelog.outputs.changelog }}

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v1
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1
    - name: Login to DockerHub
      uses: docker/login-action@v1 
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - name: Build and push
      uses: docker/build-push-action@v2
      with:
        push: true
        tags: gpao/api-gpao:${{steps.tagging.outputs.new_tag}},gpao/api-gpao:latest
        context: .
        file: docker/Dockerfile
